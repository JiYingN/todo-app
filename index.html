<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待办事项管理 | TaskFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#60A5FA',
                        accent: '#EF4444',
                        success: '#10B981',
                        warning: '#F59E0B',
                        info: '#3B82F6',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        'elevated': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .task-complete {
                @apply line-through text-gray-400;
            }
            .gradient-bg {
                background: linear-gradient(135deg, #EFF6FF 0%, #FFFFFF 100%);
            }
            .gradient-primary {
                background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%);
            }
            .priority-high {
                @apply border-l-4 border-accent;
            }
            .priority-medium {
                @apply border-l-4 border-warning;
            }
            .priority-low {
                @apply border-l-4 border-info;
            }
            .priority-none {
                @apply border-l-4 border-gray-300;
            }
            .slide-in {
                animation: slideIn 0.3s ease-out forwards;
            }
            .fade-in {
                animation: fadeIn 0.3s ease-out forwards;
            }
            .scale-in {
                animation: scaleIn 0.2s ease-out forwards;
            }
            .pulse-subtle {
                animation: pulseSubtle 2s infinite;
            }
        }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes pulseSubtle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
    </style>
</head>
<body class="font-inter min-h-screen gradient-bg text-dark antialiased">
    <!-- 顶部通知条 -->
    <div id="toastNotification" class="fixed top-0 left-0 right-0 py-3 px-4 text-center text-white transform -translate-y-full opacity-0 transition-all duration-300 z-50"></div>

    <!-- 确认操作面板 -->
    <div id="confirmOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-elevated max-w-md w-full p-6 transform transition-all scale-95 opacity-0" id="confirmDialog">
            <h3 id="confirmTitle" class="text-lg font-semibold text-gray-800 mb-2"></h3>
            <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancel" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    取消
                </button>
                <button id="confirmOk" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors">
                    确认
                </button>
            </div>
        </div>
    </div>
    
    <!-- 编辑任务模态框 -->
    <div id="editTaskModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-elevated max-w-md w-full p-6 transform transition-all scale-95 opacity-0" id="editTaskModalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">编辑任务</h3>
                <button id="closeEditTaskModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="editTaskForm" class="space-y-4">
                <input type="hidden" id="editTaskId">
                <div>
                    <label for="editTaskTitle" class="block text-sm font-medium text-gray-700 mb-1">任务标题 <span class="text-accent">*</span></label>
                    <input type="text" id="editTaskTitle" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="输入任务标题..." required="">
                </div>
                <div>
                    <label for="editTaskDescription" class="block text-sm font-medium text-gray-700 mb-1">任务描述</label>
                    <textarea id="editTaskDescription" rows="3" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="输入任务描述..."></textarea>
                </div>
                <div>
                    <label for="editTaskCategory" class="block text-sm font-medium text-gray-700 mb-1">任务分类</label>
                    <select id="editTaskCategory" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200 bg-white">
                        <option value="bms">BMS</option>
                        <option value="nvh">NVH</option>
                        <option value="dynamic">动态性能</option>
                        <option value="feishu_ai">飞书AI诊断</option>
                        <option value="other">其他</option>
                        <option value="learning">学习</option>
                        <option value="huangshan">黄山</option>
                    </select>
                </div>
                <div>
                    <label for="editTaskPriority" class="block text-sm font-medium text-gray-700 mb-1">紧急程度</label>
                    <select id="editTaskPriority" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200 bg-white">
                        <option value="P0">P0</option>
                        <option value="P1">P1</option>
                        <option value="-">-</option>
                    </select>
                </div>
                <div>
                    <label for="editTaskDueDateTime" class="block text-sm font-medium text-gray-700 mb-1">截止日期时间 <span class="text-accent">*</span></label>
                    <input type="datetime-local" id="editTaskDueDateTime" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" required="">
                    <p id="editDateError" class="text-accent text-sm mt-1 hidden">截止日期时间不能早于当前时间</p>
                </div>

            </form>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancelEditTaskModal" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    取消
                </button>
                <button id="saveEditTaskModal" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                    保存修改
                </button>
            </div>
        </div>
    </div>

    <header class="w-full py-6 px-4 md:px-8 bg-white/90 backdrop-blur-sm shadow-sm transition-all duration-300 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-[clamp(1.75rem,3vw,2.5rem)] font-bold text-gray-800 flex items-center">
                <i class="fa fa-check-square-o mr-3 text-primary text-3xl"></i>
                <span>TaskFlow</span>
                <span class="ml-2 text-sm font-normal text-gray-500 hidden sm:inline-block">高效待办事项管理</span>
            </h1>
        </div>
    </header>

    <main class="flex-grow w-full px-4 md:px-8 py-8">
        <!-- AI助手提示条 -->
        <div id="aiAssistantBanner" class="max-w-6xl mx-auto mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-md p-4 text-white flex items-center justify-between cursor-pointer transition-all duration-300 hover:shadow-lg">
            <div class="flex items-center">
                <i class="fa fa-robot text-2xl mr-3"></i>
                <div>
                    <h3 class="font-semibold">AI任务助手已上线！</h3>
                    <p class="text-sm opacity-90">用自然语言描述你的任务，AI帮你自动创建</p>
                </div>
            </div>
            <button id="showAiAssistant" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                立即体验
            </button>
        </div>
        
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-card overflow-hidden transition-all duration-300 hover:shadow-card-hover">
            <!-- 导航标签 -->
            <div class="flex border-b">
                <button id="navTasks" class="nav-tab px-6 py-4 font-medium text-primary border-b-2 border-primary transition-all duration-200">
                    <i class="fa fa-list-ul mr-2"></i>任务管理
                </button>
                <button id="navTrash" class="nav-tab px-6 py-4 font-medium text-gray-500 hover:text-gray-700 transition-all duration-200">
                    <i class="fa fa-trash mr-2"></i>回收站
                </button>
            </div>

            <!-- 任务管理区域 -->
            <div id="tasksSection" class="flex flex-col md:flex-row">
                <!-- 左侧：添加/编辑任务区域 -->
                <div class="p-6 md:p-8 border-b md:border-b-0 md:border-r border-gray-100 w-full md:w-1/3 bg-gray-50">
                    <h2 id="formTitle" class="text-xl font-semibold text-gray-700 mb-6 flex items-center">
                        <i class="fa fa-plus-circle text-primary mr-2"></i>添加新任务
                    </h2>
                    <form id="taskForm" class="space-y-5">
                        <input type="hidden" id="taskId">
                        <div>
                            <label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-1">任务标题 <span class="text-accent">*</span></label>
                            <input type="text" id="taskTitle" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="输入任务标题..." required="">
                        </div>
                        <div>
                            <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">任务描述</label>
                            <textarea id="taskDescription" rows="3" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="输入任务描述..."></textarea>
                        </div>
                        <!-- 任务分类 -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="taskCategory" class="block text-sm font-medium text-gray-700">任务分类</label>
                                <button id="manageCategories" class="text-xs text-primary hover:text-primary/80 focus:outline-none transition-colors">
                                    <i class="fa fa-cog mr-1"></i>管理分类
                                </button>
                            </div>
                            <select id="taskCategory" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200 bg-white">
                                <!-- 分类选项将通过JavaScript动态生成 -->
                            </select>
                        </div>
                        <!-- 优先级选择 -->
                        <div>
                            <label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-1">紧急程度</label>
                            <select id="taskPriority" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200 bg-white">
                                <option value="P0">P0</option>
                                <option value="P1">P1</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                        <div>
                            <label for="taskDueDateTime" class="block text-sm font-medium text-gray-700 mb-1">截止日期时间 <span class="text-accent">*</span></label>
                            <input type="datetime-local" id="taskDueDateTime" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" required="">
                            <p id="dateError" class="text-accent text-sm mt-1 hidden">截止日期时间不能早于当前时间</p>
                        </div>
                        <div class="flex space-x-3 pt-2">
                            <button type="button" id="submitTaskButton" onclick="addTask()" class="flex-1 gradient-primary hover:opacity-95 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200 transform hover:scale-[1.02] flex items-center justify-center shadow-sm">
                                <i class="fa fa-plus mr-2"></i>添加任务
                            </button>
                            <button type="button" id="cancelEditButton" class="hidden px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-all duration-200">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </form>

                    <!-- 快速统计卡片 -->
                    <div class="mt-8 bg-white rounded-xl shadow-sm p-5 border border-gray-100 slide-in">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">任务概览</h3>
                        <div class="space-y-5">
                            <div>
                                <div class="flex justify-between text-sm mb-1.5">
                                    <span class="text-gray-600">完成进度</span>
                                    <span id="completionRate" class="font-medium">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                                </div>
                            </div>
                            <!-- 按优先级统计 -->
                            <div>
                                <p class="text-xs text-gray-500 mb-2.5">按紧急程度分布</p>
                                <div class="space-y-2.5">
                                    <div class="flex items-center">
                                        <span class="w-2.5 h-2.5 rounded-full bg-accent mr-2"></span>
                                        <span class="text-xs text-gray-600 flex-1">P0</span>
                                        <span id="highPriorityCount" class="text-xs font-medium">0</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-2.5 h-2.5 rounded-full bg-warning mr-2"></span>
                                        <span class="text-xs text-gray-600 flex-1">P1</span>
                                        <span id="mediumPriorityCount" class="text-xs font-medium">0</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="w-2.5 h-2.5 rounded-full bg-info mr-2"></span>
                                        <span class="text-xs text-gray-600 flex-1">-</span>
                                        <span id="lowPriorityCount" class="text-xs font-medium">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧：任务列表区域 -->
                <div class="p-6 md:p-8 w-full md:w-2/3">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold text-gray-700 flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <i class="fa fa-tasks text-primary mr-2"></i>任务列表
                            </div>
                            <button id="exportTasks" class="px-3.5 py-1.5 rounded-md text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors">
                                <i class="fa fa-download mr-1"></i>导出Excel
                            </button>
                        </h2>
                        
                        <!-- 搜索框 -->
                        <div class="relative mb-4">
                            <input type="text" id="searchInput" class="pl-9 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200 w-full" placeholder="搜索任务标题或描述...">
                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        
                        <!-- 过滤按钮 -->
                        <div class="flex flex-wrap gap-2">
                            <button id="filterAll" class="filter-btn px-3.5 py-1.5 rounded-md text-sm bg-primary text-white shadow-sm">全部</button>
                            <button id="filterActive" class="filter-btn px-3.5 py-1.5 rounded-md text-sm bg-gray-100 hover:bg-gray-200 transition-colors">未完成</button>
                            <button id="filterCompleted" class="filter-btn px-3.5 py-1.5 rounded-md text-sm bg-gray-100 hover:bg-gray-200 transition-colors">已完成</button>
                            <div class="h-6 border-r border-gray-300 mx-1"></div>
                            <select id="categoryFilter" class="category-filter-select px-3.5 py-1.5 rounded-md text-sm bg-white border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200">
                                <option value="all">所有分类</option>
                                <option value="bms">BMS</option>
                                <option value="nvh">NVH</option>
                                <option value="dynamic">动态性能</option>
                                <option value="feishu_ai">飞书AI诊断</option>
                                <option value="other">其他</option>
                                <option value="learning">学习</option>
                                <option value="huangshan">黄山</option>
                            </select>

                            <button id="clearCompleted" class="px-3.5 py-1.5 rounded-md text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors ml-auto">
                                <i class="fa fa-trash-o mr-1"></i>清空已完成
                            </button>
                        </div>
                    </div>

                    <!-- 任务列表 -->
                    <div id="taskList" class="space-y-3 max-h-[100%] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-gray-200 scrollbar-track-transparent">
                        <!-- 任务项会通过JavaScript动态添加 -->
                        <div class="text-center text-gray-400 py-10" id="emptyTaskList">
                            <i class="fa fa-inbox text-4xl mb-3 block text-gray-300"></i>
                            <p>暂无任务，请添加新任务</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 分类管理模态框 -->
            <div id="categoryManagerModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-elevated max-w-2xl w-full max-h-[90vh] overflow-hidden transform transition-all scale-95 opacity-0" id="categoryManagerModalContent">
                    <div class="flex justify-between items-center p-6 border-b border-gray-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-500 to-teal-600 flex items-center justify-center text-white mr-3">
                                <i class="fa fa-tags text-xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800">分类管理</h3>
                        </div>
                        <button id="closeCategoryManagerModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-sm font-medium text-gray-700">自定义分类</h4>
                                <button id="addNewCategory" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-colors flex items-center">
                                    <i class="fa fa-plus mr-1"></i>添加分类
                                </button>
                            </div>
                            
                            <div id="categoriesList" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                                <!-- 分类列表将通过JavaScript动态生成 -->
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-6">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fa fa-info-circle text-blue-500"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        <strong>提示：</strong> 您可以拖拽分类项来调整显示顺序。系统默认分类（如BMS、NVH等）不可删除，但可以修改颜色。
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button id="cancelCategoryManager" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                                取消
                            </button>
                            <button id="saveCategoryChanges" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                保存更改
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 添加/编辑分类模态框 -->
            <div id="editCategoryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-elevated max-w-md w-full transform transition-all scale-95 opacity-0" id="editCategoryModalContent">
                    <div class="flex justify-between items-center p-6 border-b border-gray-100">
                        <h3 id="editCategoryTitle" class="text-lg font-semibold text-gray-800">添加新分类</h3>
                        <button id="closeEditCategoryModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <form id="editCategoryForm" class="space-y-4">
                            <input type="hidden" id="editCategoryId">
                            <div>
                                <label for="editCategoryName" class="block text-sm font-medium text-gray-700 mb-1">分类名称 <span class="text-accent">*</span></label>
                                <input type="text" id="editCategoryName" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="输入分类名称..." required>
                            </div>
                            <div>
                                <label for="editCategoryKey" class="block text-sm font-medium text-gray-700 mb-1">分类标识 <span class="text-accent">*</span></label>
                                <input type="text" id="editCategoryKey" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="英文小写，无空格..." required>
                                <p class="text-xs text-gray-500 mt-1">用于系统识别的唯一标识，建议使用英文小写字母和下划线</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">分类颜色</label>
                                <div class="grid grid-cols-6 gap-2">
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-blue-100 border-2 border-transparent hover:border-blue-500 transition-colors" data-color="bg-blue-100 text-blue-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-green-100 border-2 border-transparent hover:border-green-500 transition-colors" data-color="bg-green-100 text-green-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-purple-100 border-2 border-transparent hover:border-purple-500 transition-colors" data-color="bg-purple-100 text-purple-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-pink-100 border-2 border-transparent hover:border-pink-500 transition-colors" data-color="bg-pink-100 text-pink-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-yellow-100 border-2 border-transparent hover:border-yellow-500 transition-colors" data-color="bg-yellow-100 text-yellow-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-indigo-100 border-2 border-transparent hover:border-indigo-500 transition-colors" data-color="bg-indigo-100 text-indigo-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-red-100 border-2 border-transparent hover:border-red-500 transition-colors" data-color="bg-red-100 text-red-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-teal-100 border-2 border-transparent hover:border-teal-500 transition-colors" data-color="bg-teal-100 text-teal-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-orange-100 border-2 border-transparent hover:border-orange-500 transition-colors" data-color="bg-orange-100 text-orange-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-gray-100 border-2 border-transparent hover:border-gray-500 transition-colors" data-color="bg-gray-100 text-gray-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-cyan-100 border-2 border-transparent hover:border-cyan-500 transition-colors" data-color="bg-cyan-100 text-cyan-800"></button>
                                    <button type="button" class="color-option w-8 h-8 rounded-full bg-lime-100 border-2 border-transparent hover:border-lime-500 transition-colors" data-color="bg-lime-100 text-lime-800"></button>
                                </div>
                                <input type="hidden" id="editCategoryColor" value="bg-blue-100 text-blue-800">
                            </div>
                        </form>
                        
                        <div class="flex justify-end space-x-3 mt-4">
                            <button id="cancelEditCategory" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                                取消
                            </button>
                            <button id="saveCategory" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                保存
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI助手模态框 -->
            <div id="aiAssistantModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-elevated max-w-2xl w-full max-h-[90vh] overflow-hidden transform transition-all scale-95 opacity-0" id="aiAssistantModalContent">
                    <div class="flex justify-between items-center p-6 border-b border-gray-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white mr-3">
                                <i class="fa fa-robot text-xl"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800">AI任务助手</h3>
                        </div>
                        <div class="flex items-center">
                            <button id="toggleAiSettings" class="text-gray-400 hover:text-gray-600 focus:outline-none mr-4" title="API设置">
                                <i class="fa fa-cog text-xl"></i>
                            </button>
                            <button id="closeAiAssistantModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                                <i class="fa fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div id="aiSettingsPanel" class="hidden mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-semibold text-gray-700">API 设置</h4>
                                <span class="text-xs text-gray-500">配置保存在本地浏览器中</span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label for="aiApiKey" class="block text-xs font-medium text-gray-600 mb-1">DeepSeek API Key</label>
                                    <input type="password" id="aiApiKey" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="sk-...">
                                </div>
                                <div>
                                    <label for="aiApiUrl" class="block text-xs font-medium text-gray-600 mb-1">API Base URL</label>
                                    <input type="text" id="aiApiUrl" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="https://api.deepseek.com" value="https://api.deepseek.com">
                                </div>
                                <div class="flex justify-end">
                                    <button id="saveAiSettings" class="px-3 py-1.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors">
                                        保存设置
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="aiInput" class="block text-sm font-medium text-gray-700 mb-2">告诉AI你的待办事项</label>
                            <div class="relative">
                                <textarea id="aiInput" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-none" placeholder="例如：明天下午3点参加项目会议，这是紧急任务..."></textarea>
                                <div class="absolute bottom-3 right-3 text-xs text-gray-400">
                                    <i class="fa fa-lightbulb-o mr-1"></i>试试："周五前完成BMS报告，优先级P0"
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <div class="flex items-center mb-2">
                                <h4 class="text-sm font-medium text-gray-700">AI识别示例：</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <span class="text-gray-500">时间识别：</span>
                                    <span class="text-gray-700">"明天下午3点" → 2024-01-23 15:00</span>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <span class="text-gray-500">优先级识别：</span>
                                    <span class="text-gray-700">"紧急"、"重要" → P0</span>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <span class="text-gray-500">分类识别：</span>
                                    <span class="text-gray-700">"BMS报告" → BMS分类</span>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <span class="text-gray-500">任务类型：</span>
                                    <span class="text-gray-700">"会议"、"报告"、"学习" → 自动分类</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="aiProcessing" class="hidden">
                            <div class="flex items-center justify-center py-8">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mr-3"></div>
                                <p class="text-gray-600">AI正在解析你的任务...</p>
                            </div>
                        </div>
                        
                        <div id="aiResult" class="hidden">
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-4">
                                <h4 class="font-medium text-blue-800 mb-2">识别结果</h4>
                                <div id="aiResultContent" class="space-y-2 text-sm">
                                    <!-- AI解析结果将在这里显示 -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button id="cancelAiAssistant" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                                取消
                            </button>
                            <button id="processAiInput" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:opacity-90 transition-all duration-200 flex items-center">
                                <i class="fa fa-magic mr-2"></i>智能解析
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 回收站区域 -->
            <div id="trashSection" class="p-6 md:p-8 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 flex items-center">
                        <i class="fa fa-trash text-accent mr-2"></i>回收站
                    </h2>
                    <button id="emptyTrash" class="px-4 py-2 rounded-md text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i class="fa fa-fire mr-1"></i>清空回收站
                    </button>
                </div>

                <!-- 回收站说明 -->
                <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fa fa-info-circle text-amber-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-amber-700">
                                已删除的任务将在回收站中保留30天，超过期限将被永久删除。
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 回收站列表 -->
                <div id="trashList" class="space-y-3 max-h-[calc(100vh-300px)] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-gray-200 scrollbar-track-transparent">
                    <!-- 回收站项会通过JavaScript动态添加 -->
                    <div class="text-center text-gray-400 py-10" id="emptyTrashList">
                        <i class="fa fa-trash-o text-4xl mb-3 block text-gray-300"></i>
                        <p>回收站是空的</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full py-4 px-4 md:px-8 bg-white/90 backdrop-blur-sm shadow-inner mt-8">
        <div class="max-w-6xl mx-auto text-center text-sm text-gray-500">
            <p>© 2023 TaskFlow | 高效管理您的待办事项</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 任务数据存储
            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            let trash = JSON.parse(localStorage.getItem('trash')) || [];
            let categories = JSON.parse(localStorage.getItem('categories')) || getDefaultCategories();
            let currentFilter = 'all';
            let currentCategory = 'all';
            let editingTaskId = null;
            let confirmCallback = null;
            let searchQuery = '';
            let editingCategoryId = null;
            let tempCategories = []; // 用于分类管理的临时数据
            let currentPage = 1;
            let tasksPerPage = 10;
            
            // 为现有任务添加优先级属性（如果没有）
            tasks = tasks.map(task => {
                if (!task.hasOwnProperty('priority')) {
                    return { ...task, priority: 'P1' };
                }
                return task;
            });
            
            // 为回收站任务添加优先级属性
            trash = trash.map(item => {
                if (!item.hasOwnProperty('priority')) {
                    return { ...item, priority: 'P1' };
                }
                return item;
            });
            
            saveData(); // 保存更新后的数据

            // DOM元素缓存
            const elements = {
                taskForm: document.getElementById('taskForm'),
                taskList: document.getElementById('taskList'),
                trashList: document.getElementById('trashList'),
                emptyTaskList: document.getElementById('emptyTaskList'),
                emptyTrashList: document.getElementById('emptyTrashList'),
                completionRate: document.getElementById('completionRate'),
                progressBar: document.getElementById('progressBar'),
                highPriorityCount: document.getElementById('highPriorityCount'),
                mediumPriorityCount: document.getElementById('mediumPriorityCount'),
                lowPriorityCount: document.getElementById('lowPriorityCount'),
                filterButtons: document.querySelectorAll('.filter-btn'),
                submitTaskButton: document.getElementById('submitTaskButton'),
                cancelEditButton: document.getElementById('cancelEditButton'),
                formTitle: document.getElementById('formTitle'),
                taskDueDateTime: document.getElementById('taskDueDateTime'),
                dateError: document.getElementById('dateError'),
                navTasks: document.getElementById('navTasks'),
                navTrash: document.getElementById('navTrash'),
                tasksSection: document.getElementById('tasksSection'),
                trashSection: document.getElementById('trashSection'),
                taskTitleInput: document.getElementById('taskTitle'),
                taskDescription: document.getElementById('taskDescription'),
                taskCategory: document.getElementById('taskCategory'),
                taskPriority: document.getElementById('taskPriority'),
                taskId: document.getElementById('taskId'),
                editTaskModal: document.getElementById('editTaskModal'),
                editTaskModalContent: document.getElementById('editTaskModalContent'),
                closeEditTaskModal: document.getElementById('closeEditTaskModal'),
                cancelEditTaskModal: document.getElementById('cancelEditTaskModal'),
                saveEditTaskModal: document.getElementById('saveEditTaskModal'),
                editTaskForm: document.getElementById('editTaskForm'),
                editTaskId: document.getElementById('editTaskId'),
                editTaskTitle: document.getElementById('editTaskTitle'),
                editTaskDescription: document.getElementById('editTaskDescription'),
                editTaskCategory: document.getElementById('editTaskCategory'),
                editTaskPriority: document.getElementById('editTaskPriority'),
                editTaskDueDateTime: document.getElementById('editTaskDueDateTime'),
                editDateError: document.getElementById('editDateError'),
                exportTasks: document.getElementById('exportTasks'),
            clearCompleted: document.getElementById('clearCompleted'),
                emptyTrash: document.getElementById('emptyTrash'),
                toastNotification: document.getElementById('toastNotification'),
                confirmOverlay: document.getElementById('confirmOverlay'),
                confirmDialog: document.getElementById('confirmDialog'),
                confirmTitle: document.getElementById('confirmTitle'),
                confirmMessage: document.getElementById('confirmMessage'),
                confirmOk: document.getElementById('confirmOk'),
                confirmCancel: document.getElementById('confirmCancel'),
                taskTitleInput: document.getElementById('taskTitle'),
                taskDescription: document.getElementById('taskDescription'),
                taskPriority: document.getElementById('taskPriority'),
                taskId: document.getElementById('taskId'),
                searchInput: document.getElementById('searchInput'),
                // AI助手相关元素
                aiAssistantBanner: document.getElementById('aiAssistantBanner'),
                showAiAssistant: document.getElementById('showAiAssistant'),
                aiAssistantModal: document.getElementById('aiAssistantModal'),
                aiAssistantModalContent: document.getElementById('aiAssistantModalContent'),
                closeAiAssistantModal: document.getElementById('closeAiAssistantModal'),
                cancelAiAssistant: document.getElementById('cancelAiAssistant'),
                processAiInput: document.getElementById('processAiInput'),
                aiInput: document.getElementById('aiInput'),
                aiProcessing: document.getElementById('aiProcessing'),
                aiResult: document.getElementById('aiResult'),
                aiResultContent: document.getElementById('aiResultContent'),
                // 分类管理相关元素
                manageCategories: document.getElementById('manageCategories'),
                categoryManagerModal: document.getElementById('categoryManagerModal'),
                categoryManagerModalContent: document.getElementById('categoryManagerModalContent'),
                closeCategoryManagerModal: document.getElementById('closeCategoryManagerModal'),
                cancelCategoryManager: document.getElementById('cancelCategoryManager'),
                saveCategoryChanges: document.getElementById('saveCategoryChanges'),
                addNewCategory: document.getElementById('addNewCategory'),
                categoriesList: document.getElementById('categoriesList'),
                editCategoryModal: document.getElementById('editCategoryModal'),
                editCategoryModalContent: document.getElementById('editCategoryModalContent'),
                closeEditCategoryModal: document.getElementById('closeEditCategoryModal'),
                cancelEditCategory: document.getElementById('cancelEditCategory'),
                saveCategory: document.getElementById('saveCategory'),
                editCategoryTitle: document.getElementById('editCategoryTitle'),
                editCategoryForm: document.getElementById('editCategoryForm'),
                editCategoryId: document.getElementById('editCategoryId'),
                editCategoryName: document.getElementById('editCategoryName'),
                editCategoryKey: document.getElementById('editCategoryKey'),
                editCategoryColor: document.getElementById('editCategoryColor'),
                
                // AI 设置相关元素
                toggleAiSettings: document.getElementById('toggleAiSettings'),
                aiSettingsPanel: document.getElementById('aiSettingsPanel'),
                aiApiKey: document.getElementById('aiApiKey'),
                aiApiUrl: document.getElementById('aiApiUrl'),
                saveAiSettings: document.getElementById('saveAiSettings')
            };

            // 初始化 AI 设置
            initAiSettings();

            // 初始化应用
            function initApp() {
                // 清理超过30天的回收站项目
                cleanupOldTrashItems();
                
                // 设置默认截止日期时间为当前时间加30分钟，并设置最小值为当前时间
                const now = new Date();
                const defaultDueDate = new Date(now);
                defaultDueDate.setMinutes(now.getMinutes() + 30);
                elements.taskDueDateTime.value = formatDateTimeForInput(defaultDueDate);
                elements.taskDueDateTime.min = formatDateTimeForInput(now);
                elements.taskCategory.value = 'bms'; // 设置默认分类
                
                // 渲染界面
                renderCategories();
                renderTasks();
                renderTrash();
                updateTaskStats();
                
                // 绑定事件处理程序
                bindEvents();
                
                // 设置定时器，每分钟更新一次剩余时间显示
                setInterval(updateRemainingTimes, 60000);
            }

            // 绑定所有事件处理程序
            function bindEvents() {
                // 状态过滤按钮事件
                const statusFilterButtons = document.querySelectorAll('#filterAll, #filterActive, #filterCompleted');
                statusFilterButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const filter = this.id.replace('filter', '').toLowerCase();
                        
                        // 更新按钮样式
                        statusFilterButtons.forEach(b => {
                            b.classList.remove('bg-primary', 'text-white', 'shadow-sm');
                            b.classList.add('bg-gray-100', 'hover:bg-gray-200');
                        });
                        this.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                        this.classList.add('bg-primary', 'text-white', 'shadow-sm');
                        
                        currentFilter = filter;
                        renderTasks();
                    });
                });
                
                // 分类过滤下拉框事件
                const categoryFilterSelect = document.getElementById('categoryFilter');
                if (categoryFilterSelect) {
                    categoryFilterSelect.addEventListener('change', function() {
                        currentCategory = this.value;
                        renderTasks();
                    });
                }
                
                // 提交任务按钮
                console.log('Binding submitTaskButton click event');
                console.log('submitTaskButton element:', elements.submitTaskButton);
                
                // 移除可能存在的旧事件监听器，避免重复绑定
                const newButton = elements.submitTaskButton.cloneNode(true);
                elements.submitTaskButton.parentNode.replaceChild(newButton, elements.submitTaskButton);
                elements.submitTaskButton = newButton;
                
                // 重新绑定事件
                elements.submitTaskButton.addEventListener('click', function() {
                    console.log('submitTaskButton clicked');
                    addTask();
                });
                
                // 确保HTML中的onclick属性也指向正确的函数
                elements.submitTaskButton.setAttribute('onclick', 'addTask()');
                
                // 编辑任务模态框事件监听
                elements.closeEditTaskModal.addEventListener('click', closeEditTaskModal);
                elements.cancelEditTaskModal.addEventListener('click', closeEditTaskModal);
                elements.saveEditTaskModal.addEventListener('click', updateTask);
                
                // 点击模态框外部关闭
                elements.editTaskModal.addEventListener('click', function(e) {
                    if (e.target === elements.editTaskModal) {
                        closeEditTaskModal();
                    }
                });
                
                // 导航标签切换
                elements.navTasks.addEventListener('click', () => showSection('tasks'));
                elements.navTrash.addEventListener('click', () => showSection('trash'));
                
                // 清空已完成按钮
                elements.exportTasks.addEventListener('click', exportTasksToExcel);
                elements.clearCompleted.addEventListener('click', handleClearCompleted);
                
                // 清空回收站按钮
                elements.emptyTrash.addEventListener('click', handleEmptyTrash);
                
                // 日期验证
                elements.taskDueDateTime.addEventListener('change', validateDueDate);
                
                // 搜索功能
                elements.searchInput.addEventListener('input', function(e) {
                    searchQuery = e.target.value.trim().toLowerCase();
                    renderTasks();
                });
                
                // 按Enter键提交表单
                elements.taskForm.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (editingTaskId) {
                            updateTask();
                        } else {
                            addTask();
                        }
                    }
                });
                
                // 确认对话框事件
                elements.confirmOk.addEventListener('click', function() {
                    hideConfirmDialog();
                    if (typeof confirmCallback === 'function') {
                        confirmCallback(true);
                    }
                });
                
                elements.confirmCancel.addEventListener('click', function() {
                    hideConfirmDialog();
                    if (typeof confirmCallback === 'function') {
                        confirmCallback(false);
                    }
                });
                
                // AI助手相关事件绑定
                elements.aiAssistantBanner.addEventListener('click', showAiAssistantModal);
                elements.showAiAssistant.addEventListener('click', function(e) {
                    e.stopPropagation(); // 防止事件冒泡
                    showAiAssistantModal();
                });
                elements.closeAiAssistantModal.addEventListener('click', closeAiAssistantModal);
                elements.cancelAiAssistant.addEventListener('click', closeAiAssistantModal);
                elements.processAiInput.addEventListener('click', processAiInput);
                
                // 点击模态框外部关闭
                elements.aiAssistantModal.addEventListener('click', function(e) {
                    if (e.target === elements.aiAssistantModal) {
                        closeAiAssistantModal();
                    }
                });
                
                // 分类管理相关事件绑定
                elements.manageCategories.addEventListener('click', showCategoryManager);
                elements.closeCategoryManagerModal.addEventListener('click', closeCategoryManager);
                elements.cancelCategoryManager.addEventListener('click', closeCategoryManager);
                elements.saveCategoryChanges.addEventListener('click', saveCategoryChanges);
                elements.addNewCategory.addEventListener('click', addNewCategory);
                
                // 编辑分类相关事件绑定
                elements.closeEditCategoryModal.addEventListener('click', closeEditCategoryModal);
                elements.cancelEditCategory.addEventListener('click', closeEditCategoryModal);
                elements.saveCategory.addEventListener('click', saveCategory);
                
                // 点击模态框外部关闭
                elements.categoryManagerModal.addEventListener('click', function(e) {
                    if (e.target === elements.categoryManagerModal) {
                        closeCategoryManager();
                    }
                });
                
                elements.editCategoryModal.addEventListener('click', function(e) {
                    if (e.target === elements.editCategoryModal) {
                        closeEditCategoryModal();
                    }
                });
            }

            // 显示顶部通知
            function showToast(message, type = 'info') {
                const toast = elements.toastNotification;
                toast.textContent = message;
                
                // 设置通知样式
                toast.className = 'fixed top-0 left-0 right-0 py-3 px-4 text-center text-white transform -translate-y-full opacity-0 transition-all duration-300 z-50';
                
                if (type === 'success') {
                    toast.classList.add('bg-success');
                } else if (type === 'error') {
                    toast.classList.add('bg-accent');
                } else {
                    toast.classList.add('bg-primary');
                }
                
                // 显示通知
                setTimeout(() => {
                    toast.classList.remove('-translate-y-full', 'opacity-0');
                }, 10);
                
                // 3秒后隐藏
                setTimeout(() => {
                    toast.classList.add('-translate-y-full', 'opacity-0');
                }, 3000);
            }

            // 导出任务为Excel
            function exportTasksToExcel() {
                try {
                    // 获取所有任务数据
                    const tasksToExport = JSON.parse(localStorage.getItem('tasks')) || [];
                    
                    if (tasksToExport.length === 0) {
                        showToast('没有任务数据可以导出', 'info');
                        return;
                    }

                    // 获取分类数据
                    const categories = JSON.parse(localStorage.getItem('categories')) || [];
                    const categoryMap = {};
                    categories.forEach(cat => {
                        categoryMap[cat.key] = cat.name;
                    });

                    // 准备Excel数据
                    const excelData = tasksToExport.map(task => {
                        return {
                            '任务分类': categoryMap[task.category] || task.category || '未分类',
                            '任务标题': task.title || '',
                            '任务描述': task.description || '',
                            '紧急程度': task.priority === 'P0' ? 'P0' : (task.priority === 'P1' ? 'P1' : '-'),
                            '截止日期': task.dueDateTime ? new Date(task.dueDateTime).toLocaleDateString('zh-CN') : '',
                            '是否已完成': task.completed ? '是' : '否'
                        };
                    });

                    // 创建工作簿
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(excelData);

                    // 设置列宽
                    const colWidths = [
                        { wch: 15 }, // 任务分类
                        { wch: 25 }, // 任务标题
                        { wch: 40 }, // 任务描述
                        { wch: 10 }, // 紧急程度
                        { wch: 15 }, // 截止日期
                        { wch: 10 }  // 是否已完成
                    ];
                    ws['!cols'] = colWidths;

                    // 添加工作表到工作簿
                    XLSX.utils.book_append_sheet(wb, ws, '任务列表');

                    // 生成文件名
                    const fileName = `任务列表_${new Date().toISOString().split('T')[0]}.xlsx`;

                    // 导出文件
                    XLSX.writeFile(wb, fileName);

                    showToast('任务数据已成功导出为Excel文件', 'success');
                } catch (error) {
                    console.error('导出Excel文件失败:', error);
                    showToast('导出Excel文件失败，请重试', 'error');
                }
            }

            // 显示确认对话框
            function showConfirmDialog(title, message, callback) {
                elements.confirmTitle.textContent = title;
                elements.confirmMessage.textContent = message;
                confirmCallback = callback;
                
                elements.confirmOverlay.classList.remove('hidden');
                elements.confirmOverlay.classList.add('flex');
                
                // 添加动画效果
                setTimeout(() => {
                    elements.confirmDialog.classList.remove('scale-95', 'opacity-0');
                    elements.confirmDialog.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            // 隐藏确认对话框
            function hideConfirmDialog() {
                elements.confirmDialog.classList.remove('scale-100', 'opacity-100');
                elements.confirmDialog.classList.add('scale-95', 'opacity-0');
                
                setTimeout(() => {
                    elements.confirmOverlay.classList.add('hidden');
                    elements.confirmOverlay.classList.remove('flex');
                    confirmCallback = null;
                }, 300);
            }

            // 显示指定区域
            function showSection(section) {
                if (section === 'tasks') {
                    elements.tasksSection.classList.remove('hidden');
                    elements.trashSection.classList.add('hidden');
                    elements.navTasks.classList.add('text-primary', 'border-b-2', 'border-primary');
                    elements.navTasks.classList.remove('text-gray-500', 'hover:text-gray-700');
                    elements.navTrash.classList.remove('text-primary', 'border-b-2', 'border-primary');
                    elements.navTrash.classList.add('text-gray-500', 'hover:text-gray-700');
                } else {
                    elements.tasksSection.classList.add('hidden');
                    elements.trashSection.classList.remove('hidden');
                    elements.navTrash.classList.add('text-primary', 'border-b-2', 'border-primary');
                    elements.navTrash.classList.remove('text-gray-500', 'hover:text-gray-700');
                    elements.navTasks.classList.remove('text-primary', 'border-b-2', 'border-primary');
                    elements.navTasks.classList.add('text-gray-500', 'hover:text-gray-700');
                }
            }

            // 清理旧的回收站项目
            function cleanupOldTrashItems() {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const oldItemsCount = trash.filter(item => new Date(item.deletedAt) < thirtyDaysAgo).length;
                
                trash = trash.filter(item => new Date(item.deletedAt) >= thirtyDaysAgo);
                
                if (oldItemsCount > 0) {
                    saveData();
                    renderTrash();
                    showToast(`已自动清理 ${oldItemsCount} 个超过30天的回收站项目`, 'info');
                }
            }

            // 验证截止日期
            function validateDueDate() {
                const dueDateTimeValue = elements.taskDueDateTime.value;
                if (!dueDateTimeValue) {
                    elements.taskDueDateTime.classList.add('border-accent', 'focus:ring-accent/50', 'focus:border-accent');
                    elements.dateError.textContent = '请选择截止日期时间';
                    elements.dateError.classList.remove('hidden');
                    return false;
                }
                
                const dueDate = new Date(dueDateTimeValue);
                const now = new Date();
                now.setSeconds(0, 0);
                dueDate.setSeconds(0, 0);
                
                if (dueDate < now) {
                    elements.taskDueDateTime.classList.add('border-accent', 'focus:ring-accent/50', 'focus:border-accent');
                    elements.dateError.textContent = '截止日期时间不能早于当前时间';
                    elements.dateError.classList.remove('hidden');
                    return false;
                } else {
                    elements.taskDueDateTime.classList.remove('border-accent', 'focus:ring-accent/50', 'focus:border-accent');
                    elements.dateError.classList.add('hidden');
                    return true;
                }
            }



            // 添加新任务
            function addTask() {
                console.log('addTask function called');
                console.log('Form elements:', {
                    taskTitleInput: elements.taskTitleInput,
                    taskDescription: elements.taskDescription,
                    taskDueDateTime: elements.taskDueDateTime,
                    taskPriority: elements.taskPriority,
                    taskCategory: elements.taskCategory
                });
                
                // 确保所有必要的元素都存在
                if (!elements.taskTitleInput || !elements.taskDescription || !elements.taskDueDateTime || 
                    !elements.taskPriority || !elements.taskCategory) {
                    console.error('One or more form elements are missing');
                    showToast('表单元素加载失败，请刷新页面重试', 'error');
                    return;
                }
                
                const title = elements.taskTitleInput.value.trim();
                const description = elements.taskDescription.value.trim();
                const dueDateTime = elements.taskDueDateTime.value;
                const priority = elements.taskPriority.value;
                const category = elements.taskCategory.value;
                
                console.log('Form values:', { title, description, dueDateTime, priority, category });
                
                if (!title) {
                    elements.taskTitleInput.classList.add('border-accent', 'focus:ring-accent/50', 'focus:border-accent');
                    setTimeout(() => {
                        elements.taskTitleInput.classList.remove('border-accent', 'focus:ring-accent/50', 'focus:border-accent');
                    }, 2000);
                    return;
                }
                
                if (!validateDueDate()) {
                    return;
                }
                
                const newTask = {
                    id: Date.now().toString(),
                    title,
                    description,
                    category,
                    priority,
                    dueDateTime,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                tasks.unshift(newTask);
                saveData();
                resetPagination();
                renderTasks();
                updateTaskStats();
                
                // 重置表单
                elements.taskForm.reset();
                
                // 设置默认值
                const defaultDueDate = new Date();
                defaultDueDate.setMinutes(defaultDueDate.getMinutes() + 30);
                elements.taskDueDateTime.value = formatDateTimeForInput(defaultDueDate);
                elements.taskPriority.value = '-';
                elements.taskCategory.value = 'bms'; // 设置默认分类
                
                showToast('任务添加成功', 'success');
            }

            // 重置分页
            function resetPagination() {
                currentPage = 1;
            }

            // 编辑任务
            function editTask(taskId) {
                const task = tasks.find(task => task.id === taskId);
                if (!task) return;
                
                // 填充编辑模态框表单
                elements.editTaskId.value = task.id;
                elements.editTaskTitle.value = task.title;
                elements.editTaskDescription.value = task.description;
                elements.editTaskCategory.value = task.category || 'bms';
                elements.editTaskPriority.value = task.priority || 'P1';
                elements.editTaskDueDateTime.value = formatDateTimeForInput(new Date(task.dueDateTime));
                
                // 显示模态框
                elements.editTaskModal.classList.remove('hidden');
                elements.editTaskModal.classList.add('flex');
                setTimeout(() => {
                    elements.editTaskModalContent.classList.remove('scale-95', 'opacity-0');
                    elements.editTaskModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            // 更新任务
            function updateTask() {
                const taskId = elements.editTaskId.value;
                const title = elements.editTaskTitle.value.trim();
                const description = elements.editTaskDescription.value.trim();
                const dueDateTime = elements.editTaskDueDateTime.value;
                const priority = elements.editTaskPriority.value;
                const category = elements.editTaskCategory.value;
                
                if (!title || !taskId) {
                    if (!title) {
                        elements.editTaskTitle.classList.add('border-accent', 'focus:ring-accent/50', 'focus:border-accent');
                        setTimeout(() => {
                            elements.editTaskTitle.classList.remove('border-accent', 'focus:ring-accent/50', 'focus:border-accent');
                        }, 2000);
                    }
                    return;
                }
                
                // 验证日期
                const selectedDate = new Date(dueDateTime);
                const now = new Date();
                if (selectedDate < now) {
                    elements.editDateError.classList.remove('hidden');
                    return;
                } else {
                    elements.editDateError.classList.add('hidden');
                }
                
                // 更新任务
                tasks = tasks.map(task => {
                    if (task.id === taskId) {
                        return { ...task, title, description, category, priority, dueDateTime };
                    }
                    return task;
                });
                
                saveData();
                resetPagination();
                renderTasks();
                updateTaskStats();
                closeEditTaskModal();
                
                showToast('任务更新成功', 'success');
            }
            
            // 关闭编辑任务模态框
            function closeEditTaskModal() {
                elements.editTaskModalContent.classList.remove('scale-100', 'opacity-100');
                elements.editTaskModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    elements.editTaskModal.classList.remove('flex');
                    elements.editTaskModal.classList.add('hidden');
                }, 300);
            }

            // 取消编辑


            // 切换任务完成状态
            function toggleTaskStatus(taskId) {
                tasks = tasks.map(task => {
                    if (task.id === taskId) {
                        const updatedTask = { ...task, completed: !task.completed };
                        showToast(updatedTask.completed ? '任务已标记为完成' : '任务已标记为未完成', 'success');
                        return updatedTask;
                    }
                    return task;
                });
                
                saveData();
                resetPagination();
                renderTasks();
                updateTaskStats();
            }

            // 删除任务（移至回收站）
            function deleteTask(taskId) {
                showConfirmDialog(
                    '确认删除',
                    '确定要将此任务移至回收站吗？',
                    (confirmed) => {
                        if (confirmed) {
                            const taskIndex = tasks.findIndex(task => task.id === taskId);
                            if (taskIndex === -1) return;
                            
                            // 将任务移至回收站
                            const [task] = tasks.splice(taskIndex, 1);
                            trash.push({
                                ...task,
                                deletedAt: new Date().toISOString()
                            });
                            
                            saveData();
                            renderTasks();
                            renderTrash();
                            updateTaskStats();
                            
                            showToast('任务已移至回收站', 'info');
                        }
                    }
                );
            }

            // 从回收站恢复任务
            function restoreFromTrash(taskId) {
                const trashIndex = trash.findIndex(item => item.id === taskId);
                if (trashIndex === -1) return;
                
                // 从回收站移除
                const [item] = trash.splice(trashIndex, 1);
                const { deletedAt, ...taskToRestore } = item;
                
                // 恢复到任务列表
                tasks.unshift(taskToRestore);
                
                saveData();
                renderTasks();
                renderTrash();
                updateTaskStats();
                
                showToast('任务已恢复', 'success');
            }

            // 永久删除回收站项目
            function permanentlyDelete(taskId) {
                showConfirmDialog(
                    '永久删除',
                    '确定要永久删除此任务吗？此操作无法撤销。',
                    (confirmed) => {
                        if (confirmed) {
                            trash = trash.filter(item => item.id !== taskId);
                            saveData();
                            renderTrash();
                            showToast('任务已永久删除', 'info');
                        }
                    }
                );
            }

            // 处理清空已完成任务
            function handleClearCompleted() {
                const completedCount = tasks.filter(task => task.completed).length;
                if (completedCount === 0) {
                    showToast('没有已完成的任务可清空', 'info');
                    return;
                }
                
                showConfirmDialog(
                    '清空已完成任务',
                    `确定要删除所有${completedCount}个已完成的任务吗？它们将被移至回收站。`,
                    (confirmed) => {
                        if (confirmed) {
                            // 将已完成任务移至回收站
                            const completedTasks = tasks.filter(task => task.completed);
                            const tasksToTrash = completedTasks.map(task => ({
                                ...task,
                                deletedAt: new Date().toISOString()
                            }));
                            
                            trash = [...trash, ...tasksToTrash];
                            tasks = tasks.filter(task => !task.completed);
                            
                            saveData();
                            renderTasks();
                            renderTrash();
                            updateTaskStats();
                            showToast('已完成任务已移至回收站', 'success');
                        }
                    }
                );
            }

            // 处理清空回收站
            function handleEmptyTrash() {
                if (trash.length === 0) {
                    showToast('回收站已经是空的', 'info');
                    return;
                }
                
                showConfirmDialog(
                    '清空回收站',
                    `确定要永久删除回收站中的所有${trash.length}个项目吗？此操作无法撤销。`,
                    (confirmed) => {
                        if (confirmed) {
                            trash = [];
                            saveData();
                            renderTrash();
                            showToast('回收站已清空', 'success');
                        }
                    }
                );
            }

            // 格式化日期时间为显示用
            function formatDateTimeForDisplay(dateString) {
                if (!dateString) return '无';
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            // 格式化日期时间为input用
            function formatDateTimeForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // 计算剩余时间
            function calculateRemainingTime(dueDateTime, completed) {
                if (completed) return '已完成';
                
                const now = new Date();
                const dueDate = new Date(dueDateTime);
                const diffTime = dueDate - now;
                
                if (diffTime <= 0) {
                    // 已过期
                    const days = Math.floor(Math.abs(diffTime) / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((Math.abs(diffTime) % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    
                    if (days > 0) {
                        return `${days}天${hours}小时前已过期`;
                    } else {
                        return `${hours}小时前已过期`;
                    }
                } else {
                    // 剩余时间
                    const days = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    
                    if (days > 0) {
                        return `剩余 ${days}天${hours}小时`;
                    } else {
                        return `剩余 ${hours}小时`;
                    }
                }
            }

            // 更新所有任务的剩余时间显示
            function updateRemainingTimes() {
                document.querySelectorAll('.remaining-time').forEach(el => {
                    const taskId = el.getAttribute('data-task-id');
                    const task = tasks.find(t => t.id === taskId);
                    
                    if (task) {
                        const remainingTime = calculateRemainingTime(task.dueDateTime, task.completed);
                        el.textContent = remainingTime;
                        
                        // 更新样式
                        if (remainingTime.includes('已过期')) {
                            el.classList.add('text-accent');
                            el.classList.remove('text-success', 'text-gray-600');
                        } else if (task.completed) {
                            el.classList.add('text-success');
                            el.classList.remove('text-accent', 'text-gray-600');
                        } else {
                            el.classList.add('text-gray-600');
                            el.classList.remove('text-accent', 'text-success');
                        }
                    }
                });
            }

            // 计算剩余天数（用于回收站）
            function getDaysRemaining(deletedAt) {
                const deletedDate = new Date(deletedAt);
                const expiryDate = new Date(deletedDate);
                expiryDate.setDate(expiryDate.getDate() + 30);
                
                const now = new Date();
                const diffTime = expiryDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays > 0 ? diffDays : 0;
            }

            // 保存数据到本地存储
            function saveData() {
                try {
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    localStorage.setItem('trash', JSON.stringify(trash));
                    console.log('数据已保存到localStorage，任务数量:', tasks.length, '回收站数量:', trash.length);
                } catch (error) {
                    console.error('保存数据失败:', error);
                    showToast('数据保存失败，可能是存储空间不足', 'error');
                }
            }

            // 更新任务统计
            function updateTaskStats() {
                const total = tasks.length;
                const completed = tasks.filter(task => task.completed).length;
                const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                // 更新完成进度
                elements.completionRate.textContent = `${completionRate}%`;
                elements.progressBar.style.width = `${completionRate}%`;
                
                // 更新优先级统计
                const p0Priority = tasks.filter(task => !task.completed && task.priority === 'P0').length;
                const p1Priority = tasks.filter(task => !task.completed && task.priority === 'P1').length;
                const nonePriority = tasks.filter(task => !task.completed && task.priority === '-').length;
                
                elements.highPriorityCount.textContent = p0Priority;
                elements.mediumPriorityCount.textContent = p1Priority;
                elements.lowPriorityCount.textContent = nonePriority;
            }

            // 渲染任务列表
            function renderTasks() {
                // 过滤任务
                let filteredTasks = [...tasks];
                
                // 应用搜索过滤
                if (searchQuery) {
                    filteredTasks = filteredTasks.filter(task => 
                        task.title.toLowerCase().includes(searchQuery) || 
                        (task.description && task.description.toLowerCase().includes(searchQuery))
                    );
                }
                
                // 应用状态过滤
                if (currentFilter === 'active') {
                    filteredTasks = filteredTasks.filter(task => !task.completed);
                } else if (currentFilter === 'completed') {
                    filteredTasks = filteredTasks.filter(task => task.completed);
                }
                
                // 应用分类过滤
                if (currentCategory !== 'all') {
                    filteredTasks = filteredTasks.filter(task => task.category === currentCategory);
                }
                
                // 按优先级和截止日期排序
                filteredTasks.sort((a, b) => {
                    // 优先级排序（高 -> 中 -> 低 -> 无）
                    const priorityOrder = { 'P0': 2, 'P1': 1 };
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    
                    // 相同优先级按截止日期排序
                    return new Date(a.dueDateTime) - new Date(b.dueDateTime);
                });
                
                // 计算总页数
                const totalPages = Math.ceil(filteredTasks.length / tasksPerPage);
                
                // 获取当前页的任务
                const startIndex = (currentPage - 1) * tasksPerPage;
                const endIndex = startIndex + tasksPerPage;
                const currentPageTasks = filteredTasks.slice(startIndex, endIndex);
                
                // 清空列表
                elements.taskList.innerHTML = '';
                
                // 检查是否有任务
                if (filteredTasks.length === 0) {
                    elements.taskList.appendChild(elements.emptyTaskList);
                    renderPagination(0, 1);
                    return;
                }
                
                // 添加任务项
                currentPageTasks.forEach((task, index) => {
                    const taskElement = document.createElement('div');
                    
                    // 计算动画延迟，创建级联效果
                    const delay = index * 50;
                    
                    taskElement.className = `task-item p-4 bg-white rounded-xl shadow-sm transition-all duration-300 hover:shadow-md fade-in`;
                    taskElement.style.animationDelay = `${delay}ms`;
                    
                    // 设置优先级边框
                    if (task.completed) {
                        taskElement.classList.add('border-l-4', 'border-success');
                    } else if (task.priority === 'P0') {
                        taskElement.classList.add('priority-P0');
                    } else if (task.priority === 'P1') {
                        taskElement.classList.add('priority-P1');
                    } else {
                        // 无优先级时不添加特殊边框
                    }
                    
                    // 计算剩余时间
                    const remainingTime = calculateRemainingTime(task.dueDateTime, task.completed);
                    
                    // 任务项内容
                    taskElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start">
                                    <input type="checkbox" id="task-${task.id}" ${task.completed ? 'checked' : ''} 
                                        class="mt-1 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded cursor-pointer transition-colors">
                                    <label for="task-${task.id}" class="ml-3 block text-sm font-medium text-gray-700 ${task.completed ? 'task-complete' : ''}">
                                        ${task.title}
                                        ${task.category ? 
                                            `<span class="ml-2 px-2 py-0.5 text-xs rounded-full font-medium ${getCategoryColor(task.category)}">
                                                ${getCategoryName(task.category)}
                                            </span>` : ''}
                                        ${task.priority !== '-' && !task.completed ? 
                                            `<span class="ml-2 px-2 py-0.5 text-xs rounded-full font-medium 
                                                ${task.priority === 'P0' ? 'bg-accent bg-opacity-10 text-accent' : 
                                                  'bg-warning bg-opacity-10 text-warning'}">
                                                ${task.priority}
                                            </span>` : ''}
                                    </label>
                                </div>
                                ${task.description ? `
                                    <p class="mt-1 text-sm text-gray-500 ${task.completed ? 'task-complete' : ''} line-clamp-2">
                                        ${task.description}
                                    </p>
                                ` : ''}
                                <div class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-1 text-xs">
                                    <span class="flex items-center">
                                        <i class="fa fa-calendar mr-1 ${task.completed ? 'text-gray-400' : 'text-primary'}"></i>
                                        截止: ${formatDateTimeForDisplay(task.dueDateTime)}
                                    </span>
                                    <span class="flex items-center remaining-time ${remainingTime.includes('已过期') ? 'text-accent' : task.completed ? 'text-success' : 'text-gray-600'}" data-task-id="${task.id}">
                                        <i class="fa fa-clock-o mr-1"></i>
                                        ${remainingTime}
                                    </span>
                                </div>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex space-x-2">
                                <button class="edit-task-btn text-gray-400 hover:text-primary focus:outline-none transition-colors" data-task-id="${task.id}">
                                    <span class="sr-only">编辑任务</span>
                                    <i class="fa fa-pencil text-lg"></i>
                                </button>
                                <button class="delete-task-btn text-gray-400 hover:text-accent focus:outline-none transition-colors" data-task-id="${task.id}">
                                    <span class="sr-only">删除任务</span>
                                    <i class="fa fa-trash-o text-lg"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // 添加复选框事件
                    const checkbox = taskElement.querySelector(`#task-${task.id}`);
                    checkbox.addEventListener('change', () => toggleTaskStatus(task.id));
                    
                    // 添加编辑按钮事件
                    const editBtn = taskElement.querySelector('.edit-task-btn');
                    editBtn.addEventListener('click', function() {
                        const taskId = this.getAttribute('data-task-id');
                        editTask(taskId);
                    });
                    
                    // 添加删除按钮事件
                    const deleteBtn = taskElement.querySelector('.delete-task-btn');
                    deleteBtn.addEventListener('click', function() {
                        const taskId = this.getAttribute('data-task-id');
                        deleteTask(taskId);
                    });
                    
                    elements.taskList.appendChild(taskElement);
                });
                
                // 渲染分页控件
                renderPagination(filteredTasks.length, totalPages);
            }

            // 渲染分页控件
            function renderPagination(totalTasks, totalPages) {
                // 移除旧的分页控件
                const oldPagination = document.querySelector('.pagination-container');
                if (oldPagination) {
                    oldPagination.remove();
                }
                
                // 如果没有任务或只有一页，不显示分页
                if (totalTasks === 0 || totalPages <= 1) {
                    return;
                }
                
                // 创建新的分页容器
                const paginationContainer = document.createElement('div');
                paginationContainer.className = 'flex justify-center items-center mt-6 space-x-1 pagination-container';
                
                // 添加到DOM
                elements.taskList.parentNode.appendChild(paginationContainer);
                
                // 上一页按钮
                const prevButton = document.createElement('button');
                prevButton.className = `px-3 py-1 rounded-md text-sm transition-colors ${currentPage === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600 bg-gray-100 hover:bg-gray-200'}`;
                prevButton.innerHTML = '<i class="fa fa-chevron-left"></i>';
                prevButton.disabled = currentPage === 1;
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderTasks();
                    }
                });
                paginationContainer.appendChild(prevButton);
                
                // 页码按钮
                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.className = `px-3 py-1 rounded-md text-sm transition-colors ${i === currentPage ? 'bg-primary text-white' : 'text-gray-600 bg-gray-100 hover:bg-gray-200'}`;
                    pageButton.textContent = i;
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        renderTasks();
                    });
                    paginationContainer.appendChild(pageButton);
                }
                
                // 下一页按钮
                const nextButton = document.createElement('button');
                nextButton.className = `px-3 py-1 rounded-md text-sm transition-colors ${currentPage === totalPages ? 'text-gray-300 cursor-not-allowed' : 'text-gray-600 bg-gray-100 hover:bg-gray-200'}`;
                nextButton.innerHTML = '<i class="fa fa-chevron-right"></i>';
                nextButton.disabled = currentPage === totalPages;
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderTasks();
                    }
                });
                paginationContainer.appendChild(nextButton);
                

            }

            // 渲染回收站列表
            function renderTrash() {
                // 清空列表
                elements.trashList.innerHTML = '';
                
                // 检查回收站是否为空
                if (trash.length === 0) {
                    elements.trashList.appendChild(elements.emptyTrashList);
                    return;
                }
                
                // 按删除时间排序
                const sortedTrash = [...trash].sort((a, b) => 
                    new Date(b.deletedAt) - new Date(a.deletedAt)
                );
                
                // 添加回收站项目
                sortedTrash.forEach((item, index) => {
                    const daysRemaining = getDaysRemaining(item.deletedAt);
                    const trashItem = document.createElement('div');
                    
                    // 计算动画延迟，创建级联效果
                    const delay = index * 50;
                    
                    trashItem.className = 'p-4 bg-white rounded-xl shadow-sm border-l-4 border-gray-300 transition-all duration-300 hover:shadow-md slide-in';
                    trashItem.style.animationDelay = `${delay}ms`;
                    
                    // 回收站项目内容
                    trashItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start">
                                    <label class="block text-sm font-medium text-gray-600 ${item.completed ? 'task-complete' : ''}">
                                        ${item.title}
                                        ${item.priority !== 'none' ? 
                                            `<span class="ml-2 px-2 py-0.5 text-xs rounded-full font-medium 
                                                ${item.priority === 'high' ? 'bg-accent bg-opacity-10 text-accent' : 
                                                  item.priority === 'medium' ? 'bg-warning bg-opacity-10 text-warning' : 
                                                  'bg-info bg-opacity-10 text-info'}">
                                                ${item.priority === 'high' ? '高' : item.priority === 'medium' ? '中' : '低'}优先级
                                            </span>` : ''}
                                    </label>
                                </div>
                                ${item.description ? `
                                    <p class="mt-1 text-sm text-gray-500 ${item.completed ? 'task-complete' : ''} line-clamp-2">
                                        ${item.description}
                                    </p>
                                ` : ''}
                                <div class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-1 text-xs">
                                    <span class="flex items-center text-gray-500">
                                        <i class="fa fa-calendar mr-1"></i>
                                        截止: ${formatDateTimeForDisplay(item.dueDateTime)}
                                    </span>
                                    <span class="flex items-center text-gray-500">
                                        <i class="fa fa-trash-o mr-1"></i>
                                        删除: ${formatDateTimeForDisplay(item.deletedAt)}
                                    </span>
                                    <span class="flex items-center ${daysRemaining <= 3 ? 'text-accent pulse-subtle' : 'text-gray-500'}">
                                        <i class="fa fa-clock-o mr-1"></i>
                                        ${daysRemaining} 天后永久删除
                                    </span>
                                </div>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex space-x-2">
                                <button class="restore-task-btn text-gray-400 hover:text-primary focus:outline-none transition-colors" data-task-id="${item.id}">
                                    <span class="sr-only">恢复任务</span>
                                    <i class="fa fa-undo text-lg"></i>
                                </button>
                                <button class="permanent-delete-btn text-gray-400 hover:text-accent focus:outline-none transition-colors" data-task-id="${item.id}">
                                    <span class="sr-only">永久删除</span>
                                    <i class="fa fa-times text-lg"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // 添加恢复按钮事件
                    const restoreBtn = trashItem.querySelector('.restore-task-btn');
                    restoreBtn.addEventListener('click', function() {
                        const taskId = this.getAttribute('data-task-id');
                        restoreFromTrash(taskId);
                    });
                    
                    // 添加永久删除按钮事件
                    const deleteBtn = trashItem.querySelector('.permanent-delete-btn');
                    deleteBtn.addEventListener('click', function() {
                        const taskId = this.getAttribute('data-task-id');
                        permanentlyDelete(taskId);
                    });
                    
                    elements.trashList.appendChild(trashItem);
                });
            }

            // 启动应用
            initApp();
            
            // AI助手相关函数
            function showAiAssistantModal() {
                elements.aiAssistantModal.classList.remove('hidden');
                elements.aiAssistantModal.classList.add('flex');
                setTimeout(() => {
                    elements.aiAssistantModalContent.classList.remove('scale-95', 'opacity-0');
                    elements.aiAssistantModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                elements.aiInput.focus();
            }
            
            function closeAiAssistantModal() {
                elements.aiAssistantModalContent.classList.remove('scale-100', 'opacity-100');
                elements.aiAssistantModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    elements.aiAssistantModal.classList.remove('flex');
                    elements.aiAssistantModal.classList.add('hidden');
                    // 重置状态
                    elements.aiInput.value = '';
                    elements.aiProcessing.classList.add('hidden');
                    elements.aiResult.classList.add('hidden');
                }, 300);
            }
            
            // AI 设置初始化
            function initAiSettings() {
                // 加载已保存的设置
                const savedApiKey = localStorage.getItem('deepseek_api_key');
                const savedApiUrl = localStorage.getItem('deepseek_api_url');
                
                if (savedApiKey) {
                    elements.aiApiKey.value = savedApiKey;
                }
                if (savedApiUrl) {
                    elements.aiApiUrl.value = savedApiUrl;
                }
                
                // 切换设置面板显示
                elements.toggleAiSettings.addEventListener('click', () => {
                    elements.aiSettingsPanel.classList.toggle('hidden');
                });
                
                // 保存设置
                elements.saveAiSettings.addEventListener('click', () => {
                    const apiKey = elements.aiApiKey.value.trim();
                    const apiUrl = elements.aiApiUrl.value.trim();
                    
                    if (apiKey) {
                        localStorage.setItem('deepseek_api_key', apiKey);
                    } else {
                        localStorage.removeItem('deepseek_api_key');
                    }
                    
                    if (apiUrl) {
                        localStorage.setItem('deepseek_api_url', apiUrl);
                    } else {
                        localStorage.removeItem('deepseek_api_url');
                    }
                    
                    showToast('设置已保存', 'success');
                    elements.aiSettingsPanel.classList.add('hidden');
                });
            }

            async function processAiInput() {
                const inputText = elements.aiInput.value.trim();
                if (!inputText) {
                    showToast('请输入任务描述', 'error');
                    return;
                }
                
                // 显示处理中状态
                elements.aiProcessing.classList.remove('hidden');
                elements.aiResult.classList.add('hidden');
                elements.processAiInput.disabled = true;
                
                try {
                    const apiKey = localStorage.getItem('deepseek_api_key');
                    let parsedTask;

                    if (apiKey) {
                        // 使用大模型 API
                        parsedTask = await callDeepSeekAPI(inputText, apiKey);
                    } else {
                        // 无 Key，使用本地模拟回退方案
                        showToast('未配置 API Key，使用本地模拟模式', 'info');
                        await new Promise(resolve => setTimeout(resolve, 1000)); // 模拟延迟
                        parsedTask = parseNaturalLanguageFallback(inputText);
                    }
                    
                    displayAiResult(parsedTask);
                    elements.aiProcessing.classList.add('hidden');
                    elements.aiResult.classList.remove('hidden');
                } catch (error) {
                    console.error('AI Processing Error:', error);
                    showToast('AI 解析失败，请重试', 'error');
                    elements.aiProcessing.classList.add('hidden');
                } finally {
                    elements.processAiInput.disabled = false;
                }
            }
            
            async function callDeepSeekAPI(text, apiKey) {
                const baseUrl = localStorage.getItem('deepseek_api_url') || 'https://api.deepseek.com';
                const apiUrl = `${baseUrl.replace(/\/+$/, '')}/chat/completions`;
                
                const now = new Date();
                const currentDateTimeStr = now.toLocaleString('zh-CN', { hour12: false });
                
                const systemPrompt = `你是一个智能任务助手。请从用户的输入中提取任务信息，并以严格的 JSON 格式返回。
当前时间是：${currentDateTimeStr}
你需要提取以下字段：
- title: 任务标题（必填）
- description: 任务描述（如果用户提供了细节）
- dueDateTime: 截止时间（ISO 8601 格式，YYYY-MM-DDTHH:mm:ss.sssZ，基于当前时间推算，如果未提及则留空）
- priority: 优先级，仅限 'P0' (高/紧急), 'P1' (中/普通), 'P2' (低)。默认 'P1'。
- category: 分类，仅限 'bms', 'nvh', 'dynamic', 'feishu_ai', 'learning', 'huangshan', 'other'。默认为 'other'。

请直接返回 JSON 对象，不要包含 markdown 标记（如 \`\`\`json ... \`\`\`）或其他文本。`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-reasoner', // 用户指定 R1，通常对应 deepseek-reasoner
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: text }
                            ],
                            temperature: 0.1
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`API Error: ${response.status} ${errorData.error?.message || ''}`);
                    }

                    const data = await response.json();
                    let content = data.choices[0].message.content;
                    
                    // 清理可能存在的 markdown 标记
                    content = content.replace(/```json\s*|\s*```/g, '').trim();
                    
                    // 尝试解析 JSON
                    try {
                        const task = JSON.parse(content);
                        // 确保字段存在
                        return {
                            title: task.title || text.substring(0, 20),
                            description: task.description || '',
                            dueDateTime: task.dueDateTime || '',
                            priority: ['P0', 'P1', 'P2'].includes(task.priority) ? task.priority : 'P1',
                            category: ['bms', 'nvh', 'dynamic', 'feishu_ai', 'learning', 'huangshan', 'other'].includes(task.category) ? task.category : 'other'
                        };
                    } catch (e) {
                        console.error('JSON Parse Error:', e);
                        throw new Error('无法解析模型返回的数据');
                    }
                } catch (error) {
                    // 如果是 R1 模型调用失败（可能是模型名不对），尝试 fallback 到 deepseek-chat
                    if (error.message.includes('404') || error.message.includes('model')) {
                        console.warn('DeepSeek R1 model failed, trying deepseek-chat...');
                        return await callDeepSeekAPIWithModel(text, apiKey, 'deepseek-chat', systemPrompt, apiUrl);
                    }
                    throw error;
                }
            }

            // 辅助函数：指定模型调用（用于重试）
            async function callDeepSeekAPIWithModel(text, apiKey, model, systemPrompt, apiUrl) {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: text }
                        ],
                        temperature: 0.1
                    })
                });
                 if (!response.ok) throw new Error('API Error');
                 const data = await response.json();
                 let content = data.choices[0].message.content;
                 content = content.replace(/```json\s*|\s*```/g, '').trim();
                 return JSON.parse(content);
            }
            
            function parseNaturalLanguageFallback(text) {
                // 这里是模拟的自然语言解析逻辑
                const task = {
                    title: '',
                    description: '',
                    dueDateTime: '',
                    priority: '-',
                    category: 'other'
                };
                
                // 提取标题（简单处理：取第一句话）
                const firstSentence = text.split(/[。！？]/)[0];
                task.title = firstSentence.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '').trim();
                
                // 提取描述（剩余部分）
                const remainingText = text.substring(firstSentence.length).trim();
                if (remainingText) {
                    task.description = remainingText;
                }
                
                // 解析时间
                task.dueDateTime = parseDateTime(text);
                
                // 解析优先级
                task.priority = parsePriority(text);
                
                // 解析分类
                task.category = parseCategory(text);
                
                return task;
            }
            
            function parseDateTime(text) {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                // 简单的时间表达式匹配
                if (text.includes('明天') || text.includes('明日')) {
                    if (text.includes('下午')) {
                        const hourMatch = text.match(/下午(\d{1,2})[点:]/);
                        if (hourMatch) {
                            const hour = parseInt(hourMatch[1]) + 12;
                            tomorrow.setHours(hour, 0, 0, 0);
                            return tomorrow.toISOString();
                        }
                    } else if (text.includes('上午')) {
                        const hourMatch = text.match(/上午(\d{1,2})[点:]/);
                        if (hourMatch) {
                            const hour = parseInt(hourMatch[1]);
                            tomorrow.setHours(hour, 0, 0, 0);
                            return tomorrow.toISOString();
                        }
                    } else if (text.includes('晚上')) {
                        const hourMatch = text.match(/晚上(\d{1,2})[点:]/);
                        if (hourMatch) {
                            const hour = parseInt(hourMatch[1]) + 12;
                            tomorrow.setHours(hour, 0, 0, 0);
                            return tomorrow.toISOString();
                        }
                    }
                    // 默认明天上午9点
                    tomorrow.setHours(9, 0, 0, 0);
                    return tomorrow.toISOString();
                }
                
                // 检查是否包含"今天"
                if (text.includes('今天') || text.includes('今日')) {
                    if (text.includes('下午')) {
                        const hourMatch = text.match(/下午(\d{1,2})[点:]/);
                        if (hourMatch) {
                            const hour = parseInt(hourMatch[1]) + 12;
                            now.setHours(hour, 0, 0, 0);
                            return now.toISOString();
                        }
                    } else if (text.includes('上午')) {
                        const hourMatch = text.match(/上午(\d{1,2})[点:]/);
                        if (hourMatch) {
                            const hour = parseInt(hourMatch[1]);
                            now.setHours(hour, 0, 0, 0);
                            return now.toISOString();
                        }
                    }
                }
                
                // 检查是否包含"周五"、"周六"等
                const weekdayMap = {
                    '周一': 1, '周二': 2, '周三': 3, '周四': 4, 
                    '周五': 5, '周六': 6, '周日': 0
                };
                
                for (const [day, dayNum] of Object.entries(weekdayMap)) {
                    if (text.includes(day)) {
                        const targetDate = new Date(now);
                        const currentDay = now.getDay();
                        const diff = (dayNum - currentDay + 7) % 7;
                        targetDate.setDate(now.getDate() + diff);
                        targetDate.setHours(9, 0, 0, 0);
                        return targetDate.toISOString();
                    }
                }
                
                // 默认30分钟后
                const defaultDate = new Date(now);
                defaultDate.setMinutes(now.getMinutes() + 30);
                return defaultDate.toISOString();
            }
            
            function parsePriority(text) {
                // 简单的优先级关键词匹配
                const lowerText = text.toLowerCase();
                if (lowerText.includes('紧急') || lowerText.includes('重要') || 
                    lowerText.includes('p0') || lowerText.includes('最高')) {
                    return 'P0';
                } else if (lowerText.includes('中等') || lowerText.includes('一般') || 
                           lowerText.includes('p1') || lowerText.includes('normal')) {
                    return 'P1';
                }
                return '-';
            }
            
            function parseCategory(text) {
                // 简单的分类关键词匹配
                const lowerText = text.toLowerCase();
                if (lowerText.includes('bms')) {
                    return 'bms';
                } else if (lowerText.includes('nvh')) {
                    return 'nvh';
                } else if (lowerText.includes('动态') || lowerText.includes('性能')) {
                    return 'dynamic';
                } else if (lowerText.includes('飞书') || lowerText.includes('ai') || lowerText.includes('人工智能')) {
                    return 'feishu_ai';
                } else if (lowerText.includes('学习') || lowerText.includes('培训') || lowerText.includes('课程')) {
                    return 'learning';
                } else if (lowerText.includes('黄山')) {
                    return 'huangshan';
                }
                return 'other';
            }
            
            function displayAiResult(task) {
                const categoryNames = {
                    'bms': 'BMS',
                    'nvh': 'NVH',
                    'dynamic': '动态性能',
                    'feishu_ai': '飞书AI诊断',
                    'other': '其他',
                    'learning': '学习',
                    'huangshan': '黄山'
                };
                
                elements.aiResultContent.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-24 text-gray-500">任务标题：</span>
                        <span class="font-medium">${task.title}</span>
                    </div>
                    ${task.description ? `
                        <div class="flex items-start">
                            <span class="w-24 text-gray-500 pt-1">任务描述：</span>
                            <span>${task.description}</span>
                        </div>
                    ` : ''}
                    <div class="flex items-center">
                        <span class="w-24 text-gray-500">截止时间：</span>
                        <span>${formatDateTimeForDisplay(task.dueDateTime)}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-24 text-gray-500">优先级：</span>
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium 
                            ${task.priority === 'P0' ? 'bg-red-100 text-red-800' : 
                              task.priority === 'P1' ? 'bg-yellow-100 text-yellow-800' : 
                              'bg-gray-100 text-gray-800'}">
                            ${task.priority}
                        </span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-24 text-gray-500">分类：</span>
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium 
                            ${task.category === 'bms' ? 'bg-blue-100 text-blue-800' : 
                              task.category === 'nvh' ? 'bg-green-100 text-green-800' : 
                              task.category === 'dynamic' ? 'bg-purple-100 text-purple-800' : 
                              task.category === 'feishu_ai' ? 'bg-pink-100 text-pink-800' : 
                              task.category === 'other' ? 'bg-gray-100 text-gray-800' : 
                              task.category === 'learning' ? 'bg-yellow-100 text-yellow-800' : 
                              'bg-indigo-100 text-indigo-800'}">
                            ${categoryNames[task.category] || task.category}
                        </span>
                    </div>
                    <div class="pt-2">
                        <button id="createTaskFromAi" class="px-4 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-colors">
                            <i class="fa fa-plus-circle mr-1"></i>创建任务
                        </button>
                    </div>
                `;
                
                // 绑定创建任务按钮事件
                document.getElementById('createTaskFromAi').addEventListener('click', function() {
                    createTaskFromAiResult(task);
                });
            }
            
            function createTaskFromAiResult(task) {
                const newTask = {
                    id: Date.now().toString(),
                    title: task.title,
                    description: task.description,
                    category: task.category,
                    priority: task.priority,
                    dueDateTime: task.dueDateTime,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                tasks.unshift(newTask);
                saveData();
                resetPagination();
                renderTasks();
                updateTaskStats();
                closeAiAssistantModal();
                showToast('任务创建成功', 'success');
            }
            
            // 分类管理相关函数
            function getDefaultCategories() {
                return [
                    { id: 'bms', name: 'BMS', key: 'bms', color: 'bg-blue-100 text-blue-800', isDefault: true, order: 1 },
                    { id: 'nvh', name: 'NVH', key: 'nvh', color: 'bg-green-100 text-green-800', isDefault: true, order: 2 },
                    { id: 'dynamic', name: '动态性能', key: 'dynamic', color: 'bg-purple-100 text-purple-800', isDefault: true, order: 3 },
                    { id: 'feishu_ai', name: '飞书AI诊断', key: 'feishu_ai', color: 'bg-pink-100 text-pink-800', isDefault: true, order: 4 },
                    { id: 'other', name: '其他', key: 'other', color: 'bg-gray-100 text-gray-800', isDefault: true, order: 5 },
                    { id: 'learning', name: '学习', key: 'learning', color: 'bg-yellow-100 text-yellow-800', isDefault: true, order: 6 },
                    { id: 'huangshan', name: '黄山', key: 'huangshan', color: 'bg-indigo-100 text-indigo-800', isDefault: true, order: 7 }
                ];
            }
            
            function renderCategories() {
                // 按顺序排序分类
                const sortedCategories = [...categories].sort((a, b) => a.order - b.order);
                
                // 清空选择框
                const taskCategorySelect = document.getElementById('taskCategory');
                taskCategorySelect.innerHTML = '';
                
                // 添加分类选项
                sortedCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.key;
                    option.textContent = category.name;
                    taskCategorySelect.appendChild(option);
                });
                
                // 更新编辑任务模态框中的分类选择
                const editTaskCategorySelect = document.getElementById('editTaskCategory');
                if (editTaskCategorySelect) {
                    editTaskCategorySelect.innerHTML = '';
                    sortedCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.key;
                        option.textContent = category.name;
                        editTaskCategorySelect.appendChild(option);
                    });
                }
                
                // 更新分类过滤下拉框
                const categoryFilterSelect = document.getElementById('categoryFilter');
                if (categoryFilterSelect) {
                    // 保留"所有分类"选项
                    const allOption = categoryFilterSelect.querySelector('option[value="all"]');
                    categoryFilterSelect.innerHTML = '';
                    if (allOption) {
                        categoryFilterSelect.appendChild(allOption);
                    } else {
                        const option = document.createElement('option');
                        option.value = 'all';
                        option.textContent = '所有分类';
                        categoryFilterSelect.appendChild(option);
                    }
                    
                    // 添加分类选项
                    sortedCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.key;
                        option.textContent = category.name;
                        categoryFilterSelect.appendChild(option);
                    });
                }
            }
            
            function showCategoryManager() {
                // 复制当前分类数据到临时数组
                tempCategories = JSON.parse(JSON.stringify(categories));
                
                // 渲染分类列表
                renderCategoriesList();
                
                // 显示模态框
                elements.categoryManagerModal.classList.remove('hidden');
                elements.categoryManagerModal.classList.add('flex');
                setTimeout(() => {
                    elements.categoryManagerModalContent.classList.remove('scale-95', 'opacity-0');
                    elements.categoryManagerModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }
            
            function closeCategoryManager() {
                elements.categoryManagerModalContent.classList.remove('scale-100', 'opacity-100');
                elements.categoryManagerModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    elements.categoryManagerModal.classList.remove('flex');
                    elements.categoryManagerModal.classList.add('hidden');
                    // 重置临时数据
                    tempCategories = [];
                }, 300);
            }
            
            function renderCategoriesList() {
                // 按顺序排序分类
                const sortedCategories = [...tempCategories].sort((a, b) => a.order - b.order);
                
                // 清空列表
                elements.categoriesList.innerHTML = '';
                
                // 添加分类项
                sortedCategories.forEach((category, index) => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 transition-all duration-200 hover:shadow-sm cursor-move';
                    categoryItem.setAttribute('data-category-id', category.id);
                    
                    categoryItem.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center mr-3 cursor-pointer edit-category-color" data-category-id="${category.id}">
                                <div class="w-4 h-4 rounded-full ${category.color.split(' ')[0]}"></div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-800">${category.name}</p>
                                <p class="text-xs text-gray-500">${category.key}</p>
                            </div>
                            ${category.isDefault ? `
                                <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800">默认</span>
                            ` : ''}
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="edit-category-btn text-gray-400 hover:text-primary focus:outline-none transition-colors" data-category-id="${category.id}">
                                <i class="fa fa-pencil"></i>
                            </button>
                            ${!category.isDefault ? `
                                <button class="delete-category-btn text-gray-400 hover:text-accent focus:outline-none transition-colors" data-category-id="${category.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            ` : ''}
                            <div class="cursor-move text-gray-400 hover:text-gray-600 transition-colors">
                                <i class="fa fa-bars"></i>
                            </div>
                        </div>
                    `;
                    
                    elements.categoriesList.appendChild(categoryItem);
                });
                
                // 绑定事件
                document.querySelectorAll('.edit-category-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const categoryId = this.getAttribute('data-category-id');
                        editCategory(categoryId);
                    });
                });
                
                document.querySelectorAll('.delete-category-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const categoryId = this.getAttribute('data-category-id');
                        deleteCategory(categoryId);
                    });
                });
                
                document.querySelectorAll('.edit-category-color').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const categoryId = this.getAttribute('data-category-id');
                        editCategoryColor(categoryId);
                    });
                });
                
                // 简单的拖拽排序功能
                makeCategoriesSortable();
            }
            
            function makeCategoriesSortable() {
                const items = elements.categoriesList.querySelectorAll('.category-item');
                let draggedItem = null;
                
                items.forEach(item => {
                    item.setAttribute('draggable', 'true');
                    
                    item.addEventListener('dragstart', function() {
                        draggedItem = this;
                        setTimeout(() => {
                            this.classList.add('opacity-50');
                        }, 0);
                    });
                    
                    item.addEventListener('dragend', function() {
                        this.classList.remove('opacity-50');
                        draggedItem = null;
                    });
                    
                    item.addEventListener('dragover', function(e) {
                        e.preventDefault();
                    });
                    
                    item.addEventListener('dragenter', function(e) {
                        e.preventDefault();
                        if (this !== draggedItem) {
                            this.classList.add('bg-gray-50');
                        }
                    });
                    
                    item.addEventListener('dragleave', function() {
                        this.classList.remove('bg-gray-50');
                    });
                    
                    item.addEventListener('drop', function() {
                        this.classList.remove('bg-gray-50');
                        
                        if (this !== draggedItem) {
                            const currentPos = Array.from(items).indexOf(draggedItem);
                            const newPos = Array.from(items).indexOf(this);
                            
                            if (currentPos < newPos) {
                                elements.categoriesList.insertBefore(draggedItem, this.nextSibling);
                            } else {
                                elements.categoriesList.insertBefore(draggedItem, this);
                            }
                            
                            // 更新顺序
                            updateCategoriesOrder();
                        }
                    });
                });
            }
            
            function updateCategoriesOrder() {
                const items = elements.categoriesList.querySelectorAll('.category-item');
                items.forEach((item, index) => {
                    const categoryId = item.getAttribute('data-category-id');
                    const category = tempCategories.find(c => c.id === categoryId);
                    if (category) {
                        category.order = index + 1;
                    }
                });
            }
            
            function addNewCategory() {
                // 重置表单
                elements.editCategoryForm.reset();
                elements.editCategoryId.value = '';
                elements.editCategoryColor.value = 'bg-blue-100 text-blue-800';
                elements.editCategoryTitle.textContent = '添加新分类';
                editingCategoryId = null;
                
                // 重置颜色选择器
                resetColorSelector();
                
                // 显示模态框
                elements.editCategoryModal.classList.remove('hidden');
                elements.editCategoryModal.classList.add('flex');
                setTimeout(() => {
                    elements.editCategoryModalContent.classList.remove('scale-95', 'opacity-0');
                    elements.editCategoryModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                elements.editCategoryName.focus();
            }
            
            function editCategory(categoryId) {
                const category = tempCategories.find(c => c.id === categoryId);
                if (!category) return;
                
                // 填充表单
                elements.editCategoryId.value = category.id;
                elements.editCategoryName.value = category.name;
                elements.editCategoryKey.value = category.key;
                elements.editCategoryColor.value = category.color;
                elements.editCategoryTitle.textContent = '编辑分类';
                editingCategoryId = categoryId;
                
                // 设置颜色选择器
                resetColorSelector();
                document.querySelector(`.color-option[data-color="${category.color}"]`).classList.add('border-2', 'border-primary');
                
                // 显示模态框
                elements.editCategoryModal.classList.remove('hidden');
                elements.editCategoryModal.classList.add('flex');
                setTimeout(() => {
                    elements.editCategoryModalContent.classList.remove('scale-95', 'opacity-0');
                    elements.editCategoryModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }
            
            function editCategoryColor(categoryId) {
                const category = tempCategories.find(c => c.id === categoryId);
                if (!category) return;
                
                // 创建颜色选择器模态框
                const colorOptions = [
                    'bg-blue-100 text-blue-800', 'bg-green-100 text-green-800', 'bg-purple-100 text-purple-800',
                    'bg-pink-100 text-pink-800', 'bg-yellow-100 text-yellow-800', 'bg-indigo-100 text-indigo-800',
                    'bg-red-100 text-red-800', 'bg-teal-100 text-teal-800', 'bg-orange-100 text-orange-800',
                    'bg-gray-100 text-gray-800', 'bg-cyan-100 text-cyan-800', 'bg-lime-100 text-lime-800'
                ];
                
                let colorSelectorHTML = `
                    <div class="p-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">选择颜色</h4>
                        <div class="grid grid-cols-6 gap-2">
                `;
                
                colorOptions.forEach(color => {
                    const isSelected = category.color === color;
                    colorSelectorHTML += `
                        <button type="button" class="color-option w-8 h-8 rounded-full ${color.split(' ')[0]} border-2 ${isSelected ? 'border-primary' : 'border-transparent'} hover:border-primary transition-colors" data-color="${color}"></button>
                    `;
                });
                
                colorSelectorHTML += `
                        </div>
                    </div>
                `;
                
                // 显示确认对话框
                showConfirmDialog(
                    '更改分类颜色',
                    colorSelectorHTML,
                    (confirmed, selectedColor) => {
                        if (confirmed && selectedColor) {
                            category.color = selectedColor;
                            renderCategoriesList();
                        }
                    },
                    true // 自定义内容
                );
                
                // 绑定颜色选择事件
                setTimeout(() => {
                    document.querySelectorAll('.color-option').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const color = this.getAttribute('data-color');
                            document.querySelectorAll('.color-option').forEach(b => {
                                b.classList.remove('border-2', 'border-primary');
                                b.classList.add('border-transparent');
                            });
                            this.classList.remove('border-transparent');
                            this.classList.add('border-2', 'border-primary');
                            
                            // 更新确认按钮的点击行为
                            const confirmOkBtn = document.getElementById('confirmOk');
                            confirmOkBtn.onclick = function() {
                                hideConfirmDialog();
                                if (typeof confirmCallback === 'function') {
                                    confirmCallback(true, color);
                                }
                            };
                        });
                    });
                }, 100);
            }
            
            function deleteCategory(categoryId) {
                const category = tempCategories.find(c => c.id === categoryId);
                if (!category || category.isDefault) return;
                
                // 检查是否有任务使用此分类
                const tasksWithCategory = tasks.filter(task => task.category === category.key);
                const message = tasksWithCategory.length > 0 
                    ? `确定要删除分类"${category.name}"吗？有${tasksWithCategory.length}个任务使用此分类，它们将被移至"其他"分类。`
                    : `确定要删除分类"${category.name}"吗？`;
                
                showConfirmDialog(
                    '删除分类',
                    message,
                    (confirmed) => {
                        if (confirmed) {
                            // 删除分类
                            tempCategories = tempCategories.filter(c => c.id !== categoryId);
                            
                            // 更新使用此分类的任务
                            if (tasksWithCategory.length > 0) {
                                tasks = tasks.map(task => {
                                    if (task.category === category.key) {
                                        return { ...task, category: 'other' };
                                    }
                                    return task;
                                });
                            }
                            
                            renderCategoriesList();
                        }
                    }
                );
            }
            
            function closeEditCategoryModal() {
                elements.editCategoryModalContent.classList.remove('scale-100', 'opacity-100');
                elements.editCategoryModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    elements.editCategoryModal.classList.remove('flex');
                    elements.editCategoryModal.classList.add('hidden');
                    editingCategoryId = null;
                }, 300);
            }
            
            function saveCategory() {
                const name = elements.editCategoryName.value.trim();
                const key = elements.editCategoryKey.value.trim().toLowerCase().replace(/\s+/g, '_');
                const color = elements.editCategoryColor.value;
                
                if (!name || !key) {
                    showToast('请填写分类名称和标识', 'error');
                    return;
                }
                
                // 检查标识是否已存在
                const existingCategory = tempCategories.find(c => c.key === key && c.id !== editingCategoryId);
                if (existingCategory) {
                    showToast('分类标识已存在', 'error');
                    return;
                }
                
                if (editingCategoryId) {
                    // 编辑现有分类
                    const category = tempCategories.find(c => c.id === editingCategoryId);
                    if (category) {
                        // 如果更改了key，需要更新使用此分类的任务
                        if (category.key !== key) {
                            tasks = tasks.map(task => {
                                if (task.category === category.key) {
                                    return { ...task, category: key };
                                }
                                return task;
                            });
                        }
                        
                        category.name = name;
                        category.key = key;
                        category.color = color;
                    }
                } else {
                    // 添加新分类
                    const newCategory = {
                        id: Date.now().toString(),
                        name: name,
                        key: key,
                        color: color,
                        isDefault: false,
                        order: tempCategories.length + 1
                    };
                    tempCategories.push(newCategory);
                }
                
                closeEditCategoryModal();
                renderCategoriesList();
            }
            
            function saveCategoryChanges() {
                // 更新分类数据
                categories = tempCategories;
                
                // 保存到本地存储
                localStorage.setItem('categories', JSON.stringify(categories));
                
                // 更新UI
                renderCategories();
                renderTasks();
                
                closeCategoryManager();
                showToast('分类设置已保存', 'success');
            }
            
            function resetColorSelector() {
                document.querySelectorAll('.color-option').forEach(btn => {
                    btn.classList.remove('border-2', 'border-primary');
                    btn.classList.add('border-transparent');
                });
                
                // 绑定颜色选择事件
                document.querySelectorAll('.color-option').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.color-option').forEach(b => {
                            b.classList.remove('border-2', 'border-primary');
                            b.classList.add('border-transparent');
                        });
                        this.classList.remove('border-transparent');
                        this.classList.add('border-2', 'border-primary');
                        elements.editCategoryColor.value = this.getAttribute('data-color');
                    });
                });
            }
            
            // 辅助函数：获取分类颜色
            function getCategoryColor(categoryKey) {
                const category = categories.find(c => c.key === categoryKey);
                return category ? category.color : 'bg-gray-100 text-gray-800';
            }
            
            // 辅助函数：获取分类名称
            function getCategoryName(categoryKey) {
                const category = categories.find(c => c.key === categoryKey);
                return category ? category.name : categoryKey.toUpperCase();
            }
            
            // 扩展showConfirmDialog函数以支持自定义内容
            const originalShowConfirmDialog = showConfirmDialog;
            showConfirmDialog = function(title, message, callback, isCustomContent = false) {
                elements.confirmTitle.textContent = title;
                
                if (isCustomContent) {
                    elements.confirmMessage.innerHTML = message;
                } else {
                    elements.confirmMessage.textContent = message;
                }
                
                confirmCallback = callback;
                
                elements.confirmOverlay.classList.remove('hidden');
                elements.confirmOverlay.classList.add('flex');
                
                setTimeout(() => {
                    elements.confirmDialog.classList.remove('scale-95', 'opacity-0');
                    elements.confirmDialog.classList.add('scale-100', 'opacity-100');
                }, 10);
            };
        });
    </script>

</body>
</html>
